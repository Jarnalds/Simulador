<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simulacros - Jugador</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container">
        <h1>Simulacros - Jugador</h1>

        <div id="join-form">
            <input type="text" id="playerNameInput" placeholder="Tu Nombre" required />
            <select id="playerRoleSelect">
                <option value="">Selecciona tu rol</option>
                <option value="Operador_1">Operador 01</option>
                <option value="diseÃ±ador">DiseÃ±ador</option>
                <option value="comunicador">Comunicador</option>
            </select>
            <button id="joinGameBtn">Unirse al Juego</button>
            <div id="playerMessages" style="color: red; margin-top: 10px;"></div>
        </div>

        <div id="game-lobby" style="display: none;">
            <p>
                Â¡Bienvenido, <strong id="playerNameDisplay"></strong> (
                <strong id="playerRoleDisplay"></strong>)!
            </p>
            <p id="lobbyMessage">Esperando que el administrador inicie el juego...</p>
        </div>

        <div id="scenario-details" style="display: none;">
            <h2>Detalles del Escenario: <span id="scenarioDetailsTitle"></span></h2>
            <p id="scenarioDetailsDescription"></p>
            <button id="startQuestionsBtn">Â¡Empezar Preguntas!</button>
        </div>

        <div id="quiz-container" style="display: none;">
            <h2 id="question"></h2>
            <div id="options-container" class="options-grid"></div>
            <p>PuntuaciÃ³n: <span id="playerScore">0</span></p>
            <div id="result"></div>
        </div>

        <div id="game-finished" style="display: none;">
            <h2>Â¡Simulacro Terminado! ðŸŽ‰</h2>
            <p>Tu puntuaciÃ³n final es: <strong id="finalPlayerScore"></strong></p>
            <p>Â¡Gracias por participar!</p>
            <button onclick="window.location.reload()">Jugar de Nuevo</button>
        </div>
    </div>

    <audio id="gameStartSound">
        <source
            src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"
            type="audio/ogg"
        />
    </audio>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const backendRenderUrl = 'https://simulador-0si7.onrender.com'; // Cambia a tu backend real
        const socket = io(backendRenderUrl);

        // Elementos DOM
        const playerNameInput = document.getElementById('playerNameInput');
        const playerRoleSelect = document.getElementById('playerRoleSelect');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const playerMessages = document.getElementById('playerMessages');

        const joinForm = document.getElementById('join-form');
        const gameLobby = document.getElementById('game-lobby');
        const scenarioDetails = document.getElementById('scenario-details');
        const scenarioDetailsTitle = document.getElementById('scenarioDetailsTitle');
        const scenarioDetailsDescription =
            document.getElementById('scenarioDetailsDescription');
        const startQuestionsBtn = document.getElementById('startQuestionsBtn');
        const quizContainer = document.getElementById('quiz-container');
        const questionElement = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const playerScoreElement = document.getElementById('playerScore');
        const resultElement = document.getElementById('result');

        const gameFinished = document.getElementById('game-finished');
        const finalPlayerScoreElement = document.getElementById('finalPlayerScore');

        const playerNameDisplay = document.getElementById('playerNameDisplay');
        const playerRoleDisplay = document.getElementById('playerRoleDisplay');
        const lobbyMessage = document.getElementById('lobbyMessage');

        const gameStartAudio = document.getElementById('gameStartSound');

        let currentQuestionId = null;

        joinGameBtn.addEventListener('click', () => {
            const name = playerNameInput.value.trim();
            const role = playerRoleSelect.value;
            if (name && role) {
                socket.emit('joinGame', { name, role, isAdmin: false });
                playerNameDisplay.textContent = name;
                playerRoleDisplay.textContent = role;
                joinForm.style.display = 'none';
                gameLobby.style.display = 'block';
                playerMessages.textContent = '';
            } else {
                playerMessages.textContent =
                    'Por favor, ingresa tu nombre y selecciona un rol.';
            }
        });

        startQuestionsBtn.addEventListener('click', () => {
            scenarioDetails.style.display = 'none';
            quizContainer.style.display = 'block';
            socket.emit('playerReadyForQuestions');
        });

        socket.on('gameStarted', (data) => {
            gameLobby.style.display = 'none';
            quizContainer.style.display = 'none';
            resultElement.textContent = '';
            playerScoreElement.textContent = '0';

            if (data && data.scenarioName && data.scenarioDescription) {
                scenarioDetailsTitle.textContent = data.scenarioName;
                scenarioDetailsDescription.textContent = data.scenarioDescription;
                scenarioDetails.style.display = 'block';

                gameStartAudio.play().catch((error) => {
                    console.error('Error playing game start audio:', error);
                });
            } else {
                scenarioDetails.style.display = 'none';
                quizContainer.style.display = 'block';
                resultElement.textContent =
                    'Â¡El simulacro ha comenzado! Esperando tu primera pregunta...';

                gameStartAudio.play().catch((error) => {
                    console.error(
                        'Error playing game start audio (fallback):',
                        error
                    );
                });
            }
        });

        socket.on('newQuestion', (question) => {
            quizContainer.style.display = 'block';
            scenarioDetails.style.display = 'none';

            currentQuestionId = question.id;
            questionElement.textContent = question.question;
            optionsContainer.innerHTML = '';
            resultElement.textContent = '';

            question.options.forEach((option) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.addEventListener('click', () =>
                    submitAnswer(question.id, option, button)
                );
                optionsContainer.appendChild(button);
            });

            // Habilitar botones
            optionsContainer.querySelectorAll('.option-button').forEach((btn) => {
                btn.disabled = false;
                btn.classList.remove('correct');
            });
        });

        function submitAnswer(questionId, selectedOption, clickedButton) {
            optionsContainer.querySelectorAll('.option-button').forEach((btn) => {
                btn.disabled = true;
            });
            socket.emit('submitAnswer', { questionId, selectedOption });
        }

        socket.on('answerResult', ({ correct, score, correctOption }) => {
            playerScoreElement.textContent = score;

            if (correct) {
                resultElement.textContent = 'Â¡Correcto! ðŸŽ‰';
                resultElement.style.color = '#4CAF50';
            } else {
                resultElement.textContent = `Incorrecto. La respuesta correcta era: ${correctOption} ðŸ˜¢`;
                resultElement.style.color = '#F44336';
            }

            // Marcar la respuesta correcta
            optionsContainer.querySelectorAll('.option-button').forEach((btn) => {
                if (btn.textContent === correctOption) {
                    btn.classList.add('correct');
                }
            });
        });

        socket.on('gameFinishedForPlayer', ({ finalScore }) => {
            quizContainer.style.display = 'none';
            gameLobby.style.display = 'none';
            joinForm.style.display = 'none';
            scenarioDetails.style.display = 'none';
            gameFinished.style.display = 'block';
            finalPlayerScoreElement.textContent = finalScore;
        });

        socket.on('waitingForGameToStart', () => {
            lobbyMessage.textContent =
                'Esperando que el administrador inicie el simulacro...';
        });

        socket.on('error', (message) => {
            playerMessages.textContent = `Error del servidor: ${message}`;
            if (message.includes('Ya estÃ¡s conectado')) {
                joinForm.style.display = 'none';
                gameLobby.style.display = 'block';
                lobbyMessage.textContent =
                    'Ya estÃ¡s conectado al juego. Esperando que el administrador inicie/continÃºe.';
            } else if (message.includes('inscripciones estÃ¡n cerradas')) {
                playerMessages.textContent = message;
                joinGameBtn.disabled = true;
                playerNameInput.disabled = true;
                playerRoleSelect.disabled = true;
            }
        });

        socket.on('adminDisconnectedNotification', (message) => {
            playerMessages.textContent = message;
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        });

        socket.on('disconnect', () => {
            playerMessages.textContent = 'Desconectado del servidor.';
            joinForm.style.display = 'block';
            gameLobby.style.display = 'none';
            quizContainer.style.display = 'none';
            scenarioDetails.style.display = 'none';
            gameFinished.style.display = 'none';
            playerNameInput.disabled = false;
            playerRoleSelect.disabled = false;
            joinGameBtn.disabled = false;
        });

        socket.on('reconnect', () => {
            playerMessages.textContent = 'Reconectado al servidor.';
        });
    </script>
</body>
</html>
