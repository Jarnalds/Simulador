<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel de Administrador de Simulacros</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container">
        <h1>Panel de Administrador de Simulacros</h1>

        <div id="connection-form">
            <input type="text" id="adminNameInput" placeholder="Tu Nombre de Admin" required />
            <button id="connectAdminBtn">Conectar como Admin</button>
        </div>

        <div id="adminControls" style="display: none;">
            <p>Admin Conectado: <strong id="adminNameDisplay"></strong></p>

            <div id="scenarioSelection" style="margin-bottom: 15px;">
                <label for="scenarioSelect">Selecciona un Escenario:</label>
                <select id="scenarioSelect">
                    <option value="">Cargando escenarios...</option>
                </select>
                <button id="selectScenarioBtn" style="margin-left: 10px;">Confirmar Escenario</button>
                <p>Escenario Activo: <strong id="activeScenarioDisplay">Ninguno</strong></p>
            </div>

            <button id="startGameBtn" disabled>Iniciar Juego</button>
            <button id="endGameBtn">Finalizar Simulacro</button>
            <button id="downloadResultsBtn" style="margin-left: 10px; display: none;">Descargar Resultados CSV</button>

            <h2>Jugadores Conectados:</h2>
            <ul id="playerList"></ul>
        </div>

        <div id="adminMessages"></div>

        <div id="finalResultsDisplay" style="display: none; margin-top: 20px;">
            <h2>Resultados Finales del Simulacro</h2>
            <table id="resultsTable">
                <thead>
                    <tr><th>Nombre</th><th>Rol</th><th>Puntuación</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const backendRenderUrl = 'https://simulador-0si7.onrender.com';
        const socket = io(backendRenderUrl);

        const adminNameInput = document.getElementById('adminNameInput');
        const connectAdminBtn = document.getElementById('connectAdminBtn');
        const connectionForm = document.getElementById('connection-form');
        const adminControls = document.getElementById('adminControls');
        const adminNameDisplay = document.getElementById('adminNameDisplay');
        const startGameBtn = document.getElementById('startGameBtn');
        const playerList = document.getElementById('playerList');
        const adminMessages = document.getElementById('adminMessages');
        const downloadResultsBtn = document.getElementById('downloadResultsBtn');
        const scenarioSelect = document.getElementById('scenarioSelect');
        const selectScenarioBtn = document.getElementById('selectScenarioBtn');
        const activeScenarioDisplay = document.getElementById('activeScenarioDisplay');
        const finalResultsDisplay = document.getElementById('finalResultsDisplay');
        const resultsTableBody = document.querySelector('#resultsTable tbody');

        // Asumiendo que 'socket' ya está definido
const endGameBtn = document.getElementById('endGameBtn');

endGameBtn.addEventListener('click', () => {
    socket.emit('endGameEarly');
    console.log('Solicitud para finalizar el juego enviada.');
});
        connectAdminBtn.addEventListener('click', () => {
            const name = adminNameInput.value.trim();
            if (name) {
                socket.emit('joinGame', { name, isAdmin: true });
                adminNameInput.disabled = true;
                connectAdminBtn.disabled = true;
            } else {
                alert('Por favor, ingresa tu nombre de administrador.');
            }
        });

        selectScenarioBtn.addEventListener('click', () => {
            const selectedScenario = scenarioSelect.value;
            if (selectedScenario) {
                socket.emit('selectScenario', selectedScenario);
                selectScenarioBtn.disabled = true;
                scenarioSelect.disabled = true;
            } else {
                alert('Por favor, selecciona un escenario.');
            }
        });

        startGameBtn.addEventListener('click', () => {
            socket.emit('startGame');
        });

        downloadResultsBtn.addEventListener('click', () => {
            window.open(`${backendRenderUrl}/download-results`, '_blank');
        });

        // Aquí está el cambio importante:
        socket.on('adminConnected', ({ scenarios }) => {
            connectionForm.style.display = 'none';
            adminControls.style.display = 'block';
            adminNameDisplay.textContent = adminNameInput.value;
            adminMessages.textContent = '¡Bienvenido, administrador! Conectado al juego. Selecciona un escenario.';

            scenarioSelect.innerHTML = '<option value="">--Selecciona--</option>';
            scenarios.forEach(({ id, name }) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                scenarioSelect.appendChild(option);
            });
        });

        socket.on('scenarioSelected', (scenarioName) => {
            activeScenarioDisplay.textContent = scenarioName;
            adminMessages.textContent = `Escenario "${scenarioName}" seleccionado. Ya puedes iniciar el juego cuando haya jugadores.`;
            startGameBtn.disabled = false;
        });

        socket.on('currentPlayers', (playersArray) => {
            playerList.innerHTML = '';
            playersArray.forEach(player => {
                const listItem = document.createElement('li');
                listItem.id = `player-${player.id}`;
                listItem.textContent = `${player.name} (${player.role})`;
                playerList.appendChild(listItem);
            });
        });

        socket.on('playerJoined', (player) => {
            const playerId = `player-${player.id}`;
            if (!document.getElementById(playerId)) {
                const listItem = document.createElement('li');
                listItem.id = playerId;
                listItem.textContent = `${player.name} (${player.role})`;
                playerList.appendChild(listItem);
                adminMessages.textContent = `${player.name} se ha unido al juego.`;
            }
        });

        socket.on('playerLeft', (player) => {
            const listItem = document.getElementById(`player-${player.id}`);
            if (listItem) listItem.remove();
            adminMessages.textContent = `${player.name} ha dejado el juego.`;
        });

        socket.on('gameStartedAdmin', () => {
            adminMessages.textContent = '¡Juego Iniciado! Los jugadores ya están recibiendo sus preguntas y avanzarán por su cuenta.';
            startGameBtn.style.display = 'none';
            downloadResultsBtn.style.display = 'none';
            finalResultsDisplay.style.display = 'none';
        });

        socket.on('finalResults', (finalScores) => {
            adminMessages.textContent = '¡Juego Finalizado! Resultados disponibles.';
            downloadResultsBtn.style.display = 'block';
            finalResultsDisplay.style.display = 'block';
            resultsTableBody.innerHTML = '';

            finalScores.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td>${player.role}</td>
                    <td>${player.score}</td>
                `;
                resultsTableBody.appendChild(row);
            });
        });

        socket.on('error', (message) => {
            adminMessages.textContent = `Error del servidor: ${message}`;
            alert(`Error: ${message}`);

            if (message.includes('administrador conectado')) {
                adminNameInput.disabled = false;
                connectAdminBtn.disabled = false;
            }

            if (message.includes('Escenario no válido.') || message.includes('selecciona un escenario')) {
                selectScenarioBtn.disabled = false;
                scenarioSelect.disabled = false;
            }
        });

        socket.on('disconnect', () => {
            adminMessages.textContent = 'Desconectado del servidor.';
            connectionForm.style.display = 'block';
            adminControls.style.display = 'none';
            adminNameInput.disabled = false;
            connectAdminBtn.disabled = false;
            startGameBtn.disabled = true;
            selectScenarioBtn.disabled = false;
            scenarioSelect.disabled = false;
            playerList.innerHTML = '';
            downloadResultsBtn.style.display = 'none';
            finalResultsDisplay.style.display = 'none';
            activeScenarioDisplay.textContent = 'Ninguno';
        });

        socket.on('resetGameFrontend', () => {
            console.log('Juego reseteado por el administrador. Reiniciando frontend.');
        });
    </script>
</body>
</html>
