<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulacros - Jugador</title> <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Simulacros - Jugador</h1> <div id="join-form">
            <input type="text" id="playerNameInput" placeholder="Tu Nombre" required>
            <select id="playerRoleSelect">
                <option value="">Selecciona tu rol</option>
                <option value="programador">Programador</option>
                <option value="diseÃ±ador">DiseÃ±ador</option>
                <option value="comunicador">Comunicador</option>
            </select>
            <button id="joinGameBtn">Unirse al Juego</button>
            <div id="playerMessages" style="color: red; margin-top: 10px;"></div>
        </div>

        <div id="game-lobby" style="display: none;">
            <p>Â¡Bienvenido, <strong id="playerNameDisplay"></strong> (<strong id="playerRoleDisplay"></strong>)!</p>
            <p id="lobbyMessage">Esperando que el administrador inicie el juego...</p>
            <p id="scenarioDisplay" style="display: none; font-weight: bold; margin-top: 10px;"></p> </div>

        <div id="quiz-container" style="display: none;">
            <h2 id="question"></h2>
            <div id="options-container" class="options-grid">
            </div>
            <p>PuntuaciÃ³n: <span id="playerScore">0</span></p>
            <div id="result"></div>
        </div>

        <div id="game-finished" style="display: none;">
            <h2>Â¡Simulacro Terminado! ðŸŽ‰</h2> <p>Tu puntuaciÃ³n final es: <strong id="finalPlayerScore"></strong></p>
            <p>Â¡Gracias por participar!</p>
            <button onclick="window.location.reload()">Jugar de Nuevo</button>
        </div>
    </div>

    <audio id="gameStartAudio" src="sounds/game-start.mp3" preload="auto"></audio>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // backend/kahoot-frontend/player.html script

        // *** IMPORTANTE: Cambia esta URL por la de tu backend desplegado (Render, Heroku, etc.) ***
        const backendRenderUrl = 'https://simulador-0si7.onrender.com'; // Â¡Tu URL de Render!
        const socket = io(backendRenderUrl);

        // Referencias a elementos del DOM
        const playerNameInput = document.getElementById('playerNameInput');
        const playerRoleSelect = document.getElementById('playerRoleSelect');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const playerMessages = document.getElementById('playerMessages');

        const joinForm = document.getElementById('join-form');
        const gameLobby = document.getElementById('game-lobby');
        const quizContainer = document.getElementById('quiz-container');
        const gameFinished = document.getElementById('game-finished');

        const playerNameDisplay = document.getElementById('playerNameDisplay');
        const playerRoleDisplay = document.getElementById('playerRoleDisplay');
        const lobbyMessage = document.getElementById('lobbyMessage');
        const questionElement = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const playerScoreElement = document.getElementById('playerScore');
        const resultElement = document.getElementById('result');
        const finalPlayerScoreElement = document.getElementById('finalPlayerScore');
        
        // --- NUEVAS REFERENCIAS DE AUDIO Y ESCENARIO ---
        const gameStartAudio = document.getElementById('gameStartAudio');
        const scenarioDisplay = document.getElementById('scenarioDisplay');
        // --- FIN NUEVAS REFERENCIAS ---

        let currentQuestionId = null;

        // --- Listeners de Eventos DOM ---
        joinGameBtn.addEventListener('click', () => {
            const name = playerNameInput.value.trim();
            const role = playerRoleSelect.value;
            if (name && role) {
                socket.emit('joinGame', { name, role, isAdmin: false });
                playerNameDisplay.textContent = name;
                playerRoleDisplay.textContent = role;
                joinForm.style.display = 'none';
                gameLobby.style.display = 'block';
                playerMessages.textContent = '';
            } else {
                playerMessages.textContent = 'Por favor, ingresa tu nombre y selecciona un rol.';
            }
        });

        // --- Eventos de Socket.IO ---

        // Modificado: Ahora recibe datos, incluyendo el nombre del escenario
        socket.on('gameStarted', (data) => {
            gameLobby.style.display = 'none';
            quizContainer.style.display = 'block';
            resultElement.textContent = 'Â¡El simulacro ha comenzado! Esperando tu primera pregunta...';
            playerScoreElement.textContent = '0';
            
            if (data && data.scenarioName) {
                scenarioDisplay.textContent = `Escenario: ${data.scenarioName}`;
                scenarioDisplay.style.display = 'block'; // AsegÃºrate de que el display estÃ© en block
            } else {
                scenarioDisplay.style.display = 'none'; // Oculta si no hay nombre de escenario
            }
        });

        // NUEVO: Listener para reproducir el sonido de inicio de juego
        socket.on('playGameStartSound', () => {
            if (gameStartAudio) {
                gameStartAudio.play().catch(error => {
                    console.error("Error al intentar reproducir el audio:", error);
                    // Esto puede ocurrir si el navegador bloquea la reproducciÃ³n automÃ¡tica sin interacciÃ³n previa del usuario.
                    // Puedes considerar aÃ±adir un mensaje al usuario si esto es un problema.
                });
            }
        });

        socket.on('waitingForGameToStart', () => {
            lobbyMessage.textContent = 'Esperando que el administrador inicie el simulacro...';
            scenarioDisplay.style.display = 'none'; // Ocultar el display del escenario mientras se espera
        });

        socket.on('newQuestion', (question) => {
            currentQuestionId = question.id;
            questionElement.textContent = question.question;
            optionsContainer.innerHTML = '';
            resultElement.textContent = ''; // Limpiar resultado de pregunta anterior
            
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                // Al hacer clic, enviamos la respuesta
                button.addEventListener('click', () => submitAnswer(question.id, option, button));
                optionsContainer.appendChild(button);
            });
            optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = false); // Habilitar botones
        });

        function submitAnswer(questionId, selectedOption, clickedButton) {
            optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = true); // Deshabilitar todos los botones
            socket.emit('submitAnswer', { questionId, selectedOption });
        }

        socket.on('answerResult', ({ correct, score, correctOption }) => {
            playerScoreElement.textContent = score;
            if (correct) {
                resultElement.textContent = 'Â¡Correcto! ðŸŽ‰';
                resultElement.style.color = '#4CAF50';
                optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                    if (btn.textContent === correctOption) {
                        btn.classList.add('correct');
                    }
                });
            } else {
                resultElement.textContent = `Incorrecto. La respuesta correcta era: ${correctOption} ðŸ˜¢`;
                resultElement.style.color = '#F44336';
                optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                    if (btn.textContent === correctOption) {
                        btn.classList.add('correct');
                    }
                });
            }
            // No hay botÃ³n "Siguiente", el backend avanza automÃ¡ticamente
        });

        socket.on('gameFinishedForPlayer', ({ finalScore }) => {
            quizContainer.style.display = 'none';
            gameLobby.style.display = 'none';
            joinForm.style.display = 'none';
            gameFinished.style.display = 'block';
            finalPlayerScoreElement.textContent = finalScore;
            scenarioDisplay.style.display = 'none'; // Ocultar el display del escenario al finalizar
        });

        socket.on('error', (message) => {
            playerMessages.textContent = `Error del servidor: ${message}`;
            if (message.includes('Ya estÃ¡s conectado')) {
                joinForm.style.display = 'none';
                gameLobby.style.display = 'block';
                lobbyMessage.textContent = 'Ya estÃ¡s conectado al juego. Esperando que el administrador inicie/continÃºe.';
            } else if (message.includes('inscripciones estÃ¡n cerradas')) { // Nuevo error para inscripciones cerradas
                playerMessages.textContent = message;
                joinGameBtn.disabled = true; // Deshabilita el botÃ³n de unirse
                playerNameInput.disabled = true;
                playerRoleSelect.disabled = true;
            }
        });

        socket.on('adminDisconnectedNotification', (message) => {
            playerMessages.textContent = message;
            // Opcional: Si el admin se desconecta y el juego termina, puedes forzar un reload
            setTimeout(() => { window.location.reload(); }, 3000);
        });

        socket.on('disconnect', () => {
            playerMessages.textContent = 'Desconectado del servidor.';
            joinForm.style.display = 'block';
            gameLobby.style.display = 'none';
            quizContainer.style.display = 'none';
            gameFinished.style.display = 'none';
            playerNameInput.disabled = false;
            playerRoleSelect.disabled = false;
            joinGameBtn.disabled = false;
            scenarioDisplay.style.display = 'none'; // Ocultar el display del escenario al desconectar
        });

        socket.on('reconnect', () => {
            playerMessages.textContent = 'Reconectado al servidor.';
        });
    </script>
</body>
</html>