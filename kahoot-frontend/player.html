<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kahoot Jugador</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Mini Kahoot Jugador</h1>
        <div id="join-form">
            <input type="text" id="playerNameInput" placeholder="Tu Nombre" required>
            <select id="playerRoleSelect">
                <option value="">Selecciona tu rol</option>
                <option value="programador">Programador</option>
                <option value="diseñador">Diseñador</option>
                <option value="comunicador">Comunicador</option>
                </select>
            <button id="joinGameBtn">Unirse al Juego</button>
            <div id="playerMessages" style="color: red; margin-top: 10px;"></div>
        </div>

        <div id="game-lobby" style="display: none;">
            <p>¡Bienvenido, <strong id="playerNameDisplay"></strong> (<strong id="playerRoleDisplay"></strong>)!</p>
            <p id="lobbyMessage">Esperando que el administrador inicie el juego...</p>
        </div>

        <div id="quiz-container" style="display: none;">
            <h2 id="question"></h2>
            <div id="options-container" class="options-grid">
                </div>
            <p>Puntuación: <span id="playerScore">0</span></p>
            <div id="result"></div>
            <button id="nextQuestionPlayerBtn" style="display: none;">Siguiente Pregunta</button>
        </div>

        <div id="game-finished" style="display: none;">
            <h2>¡Juego Terminado! 🎉</h2>
            <p>Tu puntuación final es: <strong id="finalPlayerScore"></strong></p>
            <p>¡Gracias por jugar!</p>
            <button onclick="window.location.reload()">Jugar de Nuevo</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // backend/kahoot-frontend/player.html script
        // *** IMPORTANTE: Cambia esta URL por la de tu backend desplegado (Render, Heroku, etc.) ***
        const socket = io('https://backend-6ya4.onrender.com'); // ¡Tu URL de Render!

        const playerNameInput = document.getElementById('playerNameInput');
        const playerRoleSelect = document.getElementById('playerRoleSelect');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const playerMessages = document.getElementById('playerMessages');

        const joinForm = document.getElementById('join-form');
        const gameLobby = document.getElementById('game-lobby');
        const quizContainer = document.getElementById('quiz-container');
        const gameFinished = document.getElementById('game-finished'); // Nueva referencia

        const playerNameDisplay = document.getElementById('playerNameDisplay');
        const playerRoleDisplay = document.getElementById('playerRoleDisplay');
        const lobbyMessage = document.getElementById('lobbyMessage');
        const questionElement = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const playerScoreElement = document.getElementById('playerScore');
        const resultElement = document.getElementById('result');
        const finalPlayerScoreElement = document.getElementById('finalPlayerScore'); // Nueva referencia
        const nextQuestionPlayerBtn = document.getElementById('nextQuestionPlayerBtn'); // Referencia al nuevo botón

        let currentQuestionId = null;

        joinGameBtn.addEventListener('click', () => {
            const name = playerNameInput.value.trim();
            const role = playerRoleSelect.value;
            if (name && role) {
                socket.emit('joinGame', { name, role, isAdmin: false });
                playerNameDisplay.textContent = name;
                playerRoleDisplay.textContent = role;
                joinForm.style.display = 'none';
                gameLobby.style.display = 'block';
                playerMessages.textContent = ''; // Limpiar mensajes de error anteriores
            } else {
                playerMessages.textContent = 'Por favor, ingresa tu nombre y selecciona un rol.';
            }
        });

        // *** EVENTO: gameStarted se dispara si el juego ya empezó cuando el jugador se une ***
        socket.on('gameStarted', () => {
            gameLobby.style.display = 'none';
            quizContainer.style.display = 'block';
            resultElement.textContent = '¡El juego ha comenzado! Esperando tu primera pregunta...';
            playerScoreElement.textContent = '0';
            nextQuestionPlayerBtn.style.display = 'block'; // Ocultar al inicio
        });

        socket.on('waitingForGameToStart', () => {
             lobbyMessage.textContent = 'Esperando que el administrador inicie el juego...';
        });

        socket.on('newQuestion', (question) => {
            currentQuestionId = question.id;
            questionElement.textContent = question.question;
            optionsContainer.innerHTML = '';
            resultElement.textContent = ''; // Limpiar resultado de pregunta anterior
            nextQuestionPlayerBtn.style.display = 'true'; // Ocultar botón Siguiente hasta responder

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.addEventListener('click', () => submitAnswer(question.id, option, button));
                optionsContainer.appendChild(button);
            });
            optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = false);
        });

        function submitAnswer(questionId, selectedOption, clickedButton) {
            optionsContainer.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);
            socket.emit('submitAnswer', { questionId, selectedOption });
        }

        socket.on('answerResult', ({ correct, score, correctOption }) => {
            playerScoreElement.textContent = score;
            if (correct) {
                resultElement.textContent = '¡Correcto! 🎉';
                resultElement.style.color = '#4CAF50';
                optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                    if (btn.textContent === correctOption) {
                        btn.classList.add('correct');
                    }
                });
            } else {
                resultElement.textContent = `Incorrecto. La respuesta correcta era: ${correctOption} 😢`;
                resultElement.style.color = '#F44336';
                optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                    if (btn.textContent === correctOption) {
                        btn.classList.add('correct');
                    }
                });
            }
            // *** Mostrar el botón Siguiente Pregunta después de responder ***
            nextQuestionPlayerBtn.style.display = 'block';
        });

        // *** Evento que indica que el jugador puede pedir la siguiente pregunta ***
        socket.on('readyForNextQuestion', () => {
            // Este evento se usa para asegurar que el botón "Siguiente Pregunta" se muestre.
            // Ya lo manejamos en 'answerResult'
        });

        // *** LISTENER para el botón Siguiente Pregunta del jugador ***
        nextQuestionPlayerBtn.addEventListener('click', () => {
            socket.emit('requestNextQuestionForPlayer'); // El jugador solicita la siguiente pregunta
            nextQuestionPlayerBtn.disabled = true; // Deshabilitar para evitar múltiples clics
            resultElement.textContent = ''; // Limpiar el resultado anterior
            optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('correct', 'wrong'); // Limpiar estilos de respuesta
            });
        });

        // *** NUEVO EVENTO: Cuando el juego termina para este jugador individualmente ***
        socket.on('gameFinishedForPlayer', ({ finalScore }) => {
            quizContainer.style.display = 'none'; // Ocultar el cuestionario
            gameLobby.style.display = 'none'; // Ocultar el lobby
            joinForm.style.display = 'none'; // Ocultar el formulario de unión
            gameFinished.style.display = 'block'; // Mostrar la sección de juego terminado
            finalPlayerScoreElement.textContent = finalScore; // Mostrar la puntuación final
            nextQuestionPlayerBtn.style.display = 'none'; // Ocultar el botón si el juego terminó
        });

        socket.on('error', (message) => {
            playerMessages.textContent = `Error del servidor: ${message}`;
            if (message.includes('Ya estás conectado')) {
                joinForm.style.display = 'none';
                gameLobby.style.display = 'block';
                lobbyMessage.textContent = 'Ya estás conectado al juego. Esperando que el administrador inicie/continúe.';
            }
        });

        socket.on('adminDisconnectedNotification', (message) => {
            playerMessages.textContent = message;
        });

        socket.on('disconnect', () => {
            playerMessages.textContent = 'Desconectado del servidor.';
            joinForm.style.display = 'block';
            gameLobby.style.display = 'none';
            quizContainer.style.display = 'none';
            gameFinished.style.display = 'none'; // Asegurarse de que esta también se oculte
            playerNameInput.disabled = false;
            playerRoleSelect.disabled = false;
            joinGameBtn.disabled = false;
        });

        socket.on('reconnect', () => {
            playerMessages.textContent = 'Reconectado al servidor.';
        });
    </script>
</body>
</html>