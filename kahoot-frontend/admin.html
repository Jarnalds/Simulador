<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kahoot Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Panel de Administrador de Kahoot</h1>
        <div id="connection-form">
            <input type="text" id="adminNameInput" placeholder="Tu Nombre de Admin" required>
            <button id="connectAdminBtn">Conectar como Admin</button>
        </div>

        <div id="adminControls" style="display: none;">
            <p>Admin Conectado: <strong id="adminNameDisplay"></strong></p>
            <button id="startGameBtn">Iniciar Juego</button>
            <button id="downloadResultsBtn" style="margin-left: 10px;">Descargar Resultados CSV</button>
            <h2>Jugadores Conectados:</h2>
            <ul id="playerList">
                </ul>
        </div>
        <div id="adminMessages"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // backend/kahoot-frontend/admin.html script
        const socket = io('https://backend-6ya4.onrender.com'); // ¡Tu URL de Render!

        const adminNameInput = document.getElementById('adminNameInput');
        const connectAdminBtn = document.getElementById('connectAdminBtn');
        const connectionForm = document.getElementById('connection-form');
        const adminControls = document.getElementById('adminControls');
        const adminNameDisplay = document.getElementById('adminNameDisplay');
        const startGameBtn = document.getElementById('startGameBtn');
        const playerList = document.getElementById('playerList');
        const adminMessages = document.getElementById('adminMessages');
        // *** REFERENCIA AL NUEVO BOTÓN ***
        const downloadResultsBtn = document.getElementById('downloadResultsBtn');
        connectAdminBtn.addEventListener('click', () => {
            const name = adminNameInput.value.trim();
            if (name) {
                socket.emit('joinGame', { name, isAdmin: true });
                adminNameInput.disabled = true;
                connectAdminBtn.disabled = true;
            } else {
                alert('Por favor, ingresa tu nombre de administrador.');
            }
        });

        startGameBtn.addEventListener('click', () => {
            socket.emit('startGame');
        });

        // *** LISTENER PARA EL NUEVO BOTÓN ***
        downloadResultsBtn.addEventListener('click', () => {
            // Asegúrate de usar la URL REAL de tu backend en Render
            const backendUrl = 'https://backend-6ya4.onrender.com'; // ¡Tu URL de Render!
            window.open(`${backendUrl}/download-results`, '_blank');
        });
        socket.on('adminConnected', () => {
            connectionForm.style.display = 'none';
            adminControls.style.display = 'block';
            adminNameDisplay.textContent = adminNameInput.value;
            adminMessages.textContent = '¡Bienvenido, administrador! Conectado al juego. Esperando jugadores para iniciar.';
        });

        socket.on('currentPlayers', (playersArray) => {
            playerList.innerHTML = '';
            playersArray.forEach(player => {
                const listItem = document.createElement('li');
                listItem.id = `player-${player.id}`;
                listItem.textContent = `${player.name} (${player.role})`;
                playerList.appendChild(listItem);
            });
        });

        socket.on('playerJoined', (player) => {
            const listItem = document.createElement('li');
            listItem.id = `player-${player.id}`;
            listItem.textContent = `${player.name} (${player.role})`;
            playerList.appendChild(listItem);
            adminMessages.textContent = `${player.name} se ha unido al juego.`;
        });

        socket.on('playerLeft', (player) => {
            const listItem = document.getElementById(`player-${player.id}`);
            if (listItem) {
                listItem.remove();
            }
            adminMessages.textContent = `${player.name} ha dejado el juego.`;
        });

        socket.on('gameStartedAdmin', () => {
            adminMessages.textContent = '¡Juego Iniciado! Los jugadores ya están recibiendo sus preguntas y avanzarán por su cuenta.';
            startGameBtn.style.display = 'none';
        });

        socket.on('error', (message) => {
            adminMessages.textContent = `Error del servidor: ${message}`;
            alert(`Error: ${message}`);
            if (message.includes('administrador conectado')) {
                adminNameInput.disabled = false;
                connectAdminBtn.disabled = false;
            }
        });

        socket.on('adminDisconnected', () => {
            alert('El administrador se ha desconectado. El juego ha terminado para los jugadores si el admin no se reconecta pronto.');
            window.location.reload();
        });

        socket.on('disconnect', () => {
            adminMessages.textContent = 'Desconectado del servidor.';
            connectionForm.style.display = 'block';
            adminControls.style.display = 'none';
            adminNameInput.disabled = false;
            connectAdminBtn.disabled = false;
        });
    </script>
</body>
</html>